---
- name: Purge ALL cache in Cloudflare after upload
  hosts: localhost
  connection: local
  gather_facts: false

  vars_files:
    - vaults/prod.yml

  #vars:
  
    # ────────────────────────────────────────────────
    # CHANGE THESE VALUES
    # ────────────────────────────────────────────────
    #cloudflare_api_token: "{{CLOUDFLARE_API_TOKEN}}"      # ← REQUIRED
    #cloudflare_zone_id:   "{{CLOUDFLARE_ZONE_ID}}"                   # ← REQUIRED
    # You can get zone_id from Cloudflare dashboard → Overview → right sidebar

  tasks:
    - name: Purge entire Cloudflare cache (all files)
      ansible.builtin.uri:
        url: "https://api.cloudflare.com/client/v4/zones/{{ cloudflare_zone_id }}/purge_cache"
        method: POST
        body_format: json
        body: |
          {
            "purge_everything": true
          }
        headers:
          Authorization: "Bearer {{ cloudflare_api_token }}"
          Content-Type: "application/json"
        status_code: 200
        return_content: yes
      register: purge_result
      changed_when: purge_result.json.success == true
      failed_when: purge_result.json.success != true

    - name: Show purge result
      ansible.builtin.debug:
        msg: "Cloudflare purge everything completed. Success: {{ purge_result.json.success }}. Wait 10–60 seconds for global effect."