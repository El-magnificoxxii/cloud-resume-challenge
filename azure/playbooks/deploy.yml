---
- name: Deploy Azure Storage Account + Front Door + DNS ALIAS from Bicep
  hosts: localhost
  connection: local
  vars:
    #ansible_python_interpreter: /usr/bin/python3   # remove if not needed
    resource_group: cloud-resume-challenge
    location: ukwest
    storage_account_name: abdullateefoni346088     # make sure it's unique
    custom_domain_name: abdullateefoniresume.online
    dns_zone_name: abdullateefoniresume.online     # â† NEW: required for ALIAS record
    deployment_name: "deploy-full-{{ ansible_facts.date_time.date | regex_replace('-', '') }}{{ ansible_facts.date_time.time | replace(':', '') }}"

  tasks:
    - name: Compile Bicep to ARM JSON
      ansible.builtin.command: >
        az bicep build --file ../main.bicep --outfile compiled.json
      args:
        chdir: "{{ playbook_dir }}"
      changed_when: false
      register: bicep_build
      failed_when: bicep_build.rc != 0

    - name: Deploy full infrastructure (storage + Front Door + DNS ALIAS)
      ansible.builtin.command: >
        az deployment group create
        --resource-group {{ resource_group }}
        --name {{ deployment_name }}
        --template-file compiled.json
        --parameters
          location={{ location }}
          storage_account_name={{ storage_account_name }}
          custom_domain_name={{ custom_domain_name }}
          dns_zone_name={{ dns_zone_name }}
        --output json
      args:
        chdir: "{{ playbook_dir }}"
      register: deployment_result
      changed_when: "'Succeeded' in deployment_result.stdout"
      failed_when: deployment_result.rc != 0

    - name: Show deployment provisioning state
      ansible.builtin.debug:
        msg: "{{ deployment_result.stdout | from_json | json_query('properties.provisioningState') }}"

    - name: Show useful outputs from deployment
      ansible.builtin.debug:
        msg:
          - "Storage Blob Endpoint: {{ deployment_result.stdout | from_json | json_query('properties.outputs.storageBlobEndpoint.value') | default('Not available') }}"
          - "Front Door Endpoint Hostname: {{ deployment_result.stdout | from_json | json_query('properties.outputs.frontDoorEndpointHostname.value') | default('Not available') }}"
          - "Custom Domain URL: {{ deployment_result.stdout | from_json | json_query('properties.outputs.customDomainUrl.value') | default('Not available') }}"

    - name: Remove temporary compiled JSON file
      ansible.builtin.file:
        path: "{{ playbook_dir }}/compiled.json"
        state: absent

    - name: Enable static website hosting on storage account (force if needed)
      ansible.builtin.command: >
        az storage blob service-properties update
        --account-name {{ storage_account_name }}
        --static-website true
        --index-document index.html
        --404-document index.html
        --auth-mode login
      args:
        chdir: "{{ playbook_dir }}"
      register: static_enable_result
      changed_when: static_enable_result.rc == 0
      failed_when: static_enable_result.rc != 0 and 'already' not in static_enable_result.stderr | default('')